<!-- @layout "default.html" -->
<link rel="stylesheet" href="/public/code.css">
<script src="/public/lib.js"></script>

<style>
#heading-cont {
    margin-left: auto;
    margin-right: auto;
    margin: 2vh auto;

    width: 80vw;
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;

    --part: var(--skua-foreground);
    --working: powderblue;
}

#backlink > code * {
    text-decoration: none;
    padding: 0 1px;
}
   
#heading-cont > form {
    margin: 0;
}

#heading-cont input {
    border: var(--skua-foreground) 1px solid;   
    background-color: var(--skua-accent);
    font-family: monospace;
    padding-left: 10px;
}
</style>

<div id="heading-cont">
    <h1 id="backlink"><code>[ backlink ]</code></h1>
    <form class="path-opts" data-value="dir">
        <input id="query" type="search" placeholder="query" />
        <button>search</button>
    </form>
</div>

<option class="path-opts" value="dir">
    <figure>
        <table>
            <thead>
                <tr>
                    <th>name</th>
                    <th>last commit</th>
                    <th>commit message</th>
                </tr>
            </thead>
            <tbody id="repos">
                <tr id="row">
                    <td><a class="repo-name" href="[ filename ]">[ name ]</a></td>
                    <td class="row-date">[ lastCommit ]</td>
                    <td>[ commitMessage ]</td>
                </tr>
            </tbody>
        </table>
    </figure>
    <script>
    window.$event("load").on = () => {
        $("#query").$event("input").on = ev => {
            for (const row of $all("#repos > tr")) {
                const name = row.getElementsByClassName("repo-name")[0].innerText;
                row.style.display = row.id !== "row" && 
                                    name.startsWith(ev.target.value) ? "table-row" : "none";
            }
        };
    };
    </script>
    <style>
    .hidden-file {
        color: grey;
        font-style: italic;
    }

    .row-date {
        font-style: italic;
    }
    </style>
</option>
<option class="path-opts" value="file">
    <!-- on 1 line to prevent whitespace -->
    <pre data-wrap="nowrap" id="contents"><code>[ contents ]</code></pre>
    <div id="wrap-wrapper">
        <input id="wrap" type="checkbox" />
        <label for="wrap">enable wrapping</label>
    </div>
    <style>
    #wrap-wrapper {
        position: sticky;
        float: right;
        bottom: 1vh;

        width: fit-content;
        margin: 2vh 0;
        padding: 8px;

        border: var(--skua-foreground) solid 1px;
        background: var(--skua-accent);
        border-radius: 5px;
    }

    #contents {
        user-select: text;
        whitespace: pre-wrap;
    }

    #contents > code *, #contents > code {
        padding: unset;
    }

    #contents {
        white-space: pre;
        border: 20px solid var(--skua-accent);
        padding: 0;
    }

    #contents[data-wrap="nowrap"] {
        overflow: scroll;
    }
    #contents[data-wrap="wrap"], #contents:not([data-wrap]) {
        white-space: pre-wrap;
    }

    .lineno, .lineno:visited {
        color: var(--faint);
        font-style: italic;
        text-decoration: none;
        user-select: none;
    }

    .lineno.selected {
        color: var(--skua-foreground);
        font-style: normal;
        font-weight: bold;
        text-shadow: 0 0 2px var(--skua-accent-inverted);
    }
    </style>
    <script>
    function getFragBounds() {
        const frag = window.location.hash;
        let digits = frag.match(/\d+/gm);
        if (digits === null) return null;
        if (digits.length >= 3) digits = digits.slice(2);
        return digits.map(n => Number.parseInt(n)).sort((a, b) => a - b);
    }

    let selected = [];
    function frag() {
        const digits = getFragBounds();
        if (digits === null) return;
        console.log(digits);

        // reset gutter
        for (const el of selected)
            el.classList.remove("selected");
        selected = [];

        for (const idx of Array((digits[1] ?? digits[0]) - digits[0] + 1).keys()) {
            const el = $(`#L${digits[0] + idx}`);
            el.classList.add("selected");
            selected.push(el);
        }
    }

    window.$event("hashchange", "load").on = () => window.location.hash && frag();
    window.$event("load").on = () => {
        $("#wrap").$event("change").on = () => {
            $("#contents").setAttribute("data-wrap", $("#wrap").checked ? "wrap" : "nowrap");
        };

        $all(".lineno").forEach(no => {
            no.$event("click").on = ev => {
                if (!ev.shiftKey) return;
                ev.preventDefault();
                const digits = getFragBounds();
                if (digits === null) return;

                const target = ev.target.id.match(/\d+/)[0];
                const newBounds = target < digits[0] ? [target, digits[1]] : [digits[0], target];
                window.location.hash = `#L${newBounds[0]}-${newBounds[1]}`;
                frag();
            };
        });
    };

    </script>
</option>

<script>
$objEvent(server, "load").on = async () => {
    const filename = server.slugs.filename;
    const filepath = `/home/0x5da/projects/${server.slugs.name}/${filename ?? ""}`;
    const repoFilesPath = `/repo/${server.slugs.name}/${server.slugs.branch}/${server.slugs.commit}/files`;

    let cpath = repoFilesPath;
    const root = `<a href=${repoFilesPath + "/"} style="color: var(--working)">/</a>`;
    $("#backlink").$template({ backlink: root + ((filename ?? "")
        .split("/")
        .map(part => {
            cpath += "/" + part;
            const cssvar = (filename ?? "").endsWith(part) ? "working" : "part";
            return `<a href="${cpath}" style="color: var(--${cssvar})">${part}</a>`;
         })
        .join("<span style=\"color: var(--faint)\">/</span>")) });

    const isDir = !filename || runSh(`git ls-tree --format="%(objecttype)" ${server.slugs.commit} -- ${stripEnd(filename, "/")}`) === "tree";
    $all(".path-opts").$cfg(isDir ? "dir" : "file");

    // we can't just place these branches in script tags in their respective `option`s, because
    //   we'd have to `$select` the correct branch here [at the bottom of the file], by which time *both* 
    //   branches have had `load` event handlers registered. all work-arounds i found were worse than 1 if-else.
    // NOTE: we can still have window events, though!
    if (isDir) {
        const filepathQual = filepath.endsWith("/") ? filepath : filepath + "/";
        const dircontents = runShExtract(
            `git ls-tree --format="%(path) %(objecttype)" ${server.slugs.commit} ${filepathQual}`,
            "path",
            "type"
        );
    
        for (const { path, type } of dircontents) {
            // TODO: nned to get last commit date from range server.slugs.commit
            const [ time, message ] = runSh(`git log -n 1 --format="%ct%n%s" ${server.slugs.commit} -- ${path}`).split("\n");
    
            $("#row").$templateClone({
                name: path + (type === "tree" ? "/" : ""),
                filename: repoFilesPath + "/" + path,
                lastCommit: getFormattedTime(new Date(time * 1000)), // *1000 because JS wants ms
                commitMessage: message,
            }, {
                class: path.startsWith(".") ? "hidden-file" : "",
            });
        }
    } else {
        // TODO: git-ify
        const { starryNight: { common: langs, createStarryNight }, hastToHtml } = server.imports;
        const contents = runSh(`git show ${server.slugs.commit}:${server.slugs.filename}`);
        const st = await createStarryNight(langs);
        const scope = st.flagToScope(filename.split(".").pop());
        if (scope) {
            const tree = st.highlight(contents, scope);
            $("#contents").$template({ contents: hastToHtml(tree) });
        } else  
            $("#contents").$template({ contents: contents });
        

        // TODO: $retemplate
        let no = 1;
        const code = $("#contents code");
        const digits = (code.innerHTML.match(/^/gm) || []).length.toString().length;
        /* :( */
        code.innerHTML = code.innerHTML.replaceAll(/^/gm, () => `<a target="_self" href="#L${no}" id="L${no}" class="lineno">${(no++).toString().padStart(digits, "0")}</a><span style="user-select: none">  </span>`);
    }
};
</script>
