<!-- @layout "default.html" -->

<style>
.row-date {
    font-style: italic;
}
</style>

<h1 id="title">[ repoName ]</h1>

<form>
    <input id="query" type="search" placeholder="query" />
    <button>search</button>
</form>

<figure>
    <table>
        <thead>
            <tr>
                <th>name</th>
                <th>last commit</th>
                <th>commit message</th>
            </tr>
        </thead>
        <tbody id="repos">
            <tr id="row">
                <td><a class="repo-name" href="files/[ filename ]">[ name ]</a></td>
                <td class="row-date">[ lastCommit ]</td>
                <td>[ commitMessage ]</td>
            </tr>
        </tbody>
    </table>
</figure>

<style>
.hidden-file {
    color: grey;
    font-style: italic;
}
</style>

<script src="/public/falcon.js"></script>
<script src="/public/lib.js"></script>
<script>
window.$event("load").on = () => {
    $("#query").$event("input").on = ev => {
        for (const row of $all("#repos > tr")) {
            const name = row.getElementsByClassName("repo-name")[0].innerText;
            row.style.display = row.id !== "row" && 
                                name.startsWith(ev.target.value) ? "table-row" : "none";
        }
    };
};

$objEvent(server, "load").on = async () => {
    const { fs, path, git } = server.imports;
    const gitRoot = "/home/0x5da/projects/";
    const repoName = server.slugs.name;
    const repoPath = `${gitRoot}${repoName}`;
    const repo = git.simpleGit({ baseDir: repoPath });

    $("#title").$template({
        repoName: repoName,
    });

    for (const entry of fs.readdirSync(repoPath)) {
        const { latest } = await repo.log({ file: entry });
        if (!latest) continue; // TODO: wat

        $("#row").$templateClone({
            name: entry,
            filename: entry,
            lastCommit: getFormattedTime(latest.date),
            commitMessage: latest.message,
        }, {
            class: entry.startsWith(".") ? "hidden-file" : "",
        });
    }

};
</script>
